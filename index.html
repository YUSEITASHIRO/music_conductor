<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Conductor - Ver.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #222;
            color: white;
            font-family: sans-serif;
            padding-bottom: 20px;
        }
        #container {
            position: relative;
            width: 640px;
            height: 480px;
            margin-top: 10px;
            background-color: #000;
        }
        #input_video {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); 
            display: none; 
        }
        #output_canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            border: 2px solid #555;
        }
        .ui-panel {
            margin-top: 20px;
            padding: 20px;
            background: #333;
            border-radius: 8px;
            text-align: center;
            width: 600px;
        }
        input[type="file"] {
            margin-bottom: 15px;
            padding: 10px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 4px;
        }
        button {
            padding: 12px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            color: #aaa;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
            color: #00ff00;
            min-height: 1.2em;
        }
        .instructions {
            margin: 10px;
            font-size: 0.9em;
            color: #ccc;
            text-align: left;
            width: 640px;
        }
        .instructions li { margin-bottom: 5px; }
        .instructions li span { font-weight: bold; color: #fff; border-bottom: 1px solid #666;}
        .highlight { color: #ffeb3b !important; }
    </style>
</head>
<body>
    <div class="ui-panel">
        <h1>AI Conductor</h1>
        
        <div>
            <label for="audio-upload">éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ (mp3, wavç­‰): </label><br>
            <input type="file" id="audio-upload" accept="audio/*">
        </div>

        <button id="start-button" disabled>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</button>
        <div id="status">å¾…æ©Ÿä¸­...</div>
    </div>

    <div class="instructions">
        <ul>
            <li><span>ã€å³æ‰‹ã€‘ä¸Šä¸‹ã®é€Ÿã•ï¼š</span> <strong>ãƒ†ãƒ³ãƒ</strong> (å†ç”Ÿé€Ÿåº¦)ã€‚</li>
            <li><span class="highlight">ã€å³æ‰‹ã€‘ã‚°ãƒ¼ãƒ»ãƒ‘ãƒ¼ï¼š</span> <strong>éŸ³ã®æ˜æš— (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)</strong>ã€‚<br>ã‚°ãƒ¼âœŠ = ã“ã‚‚ã‚‹ (æŠ‘ãˆã‚‹)ã€ ãƒ‘ãƒ¼ğŸ– = æ˜ã‚‹ãé–‹æ”¾ï¼</li>
            <li><span>ã€å·¦æ‰‹ã€‘é«˜ã•ï¼š</span> <strong>éŸ³é‡</strong> (ä¸Š=å¤§ã€ä¸‹=å°)ã€‚</li>
            <li><span class="highlight">ã€å·¦æ‰‹ã€‘ã‚°ãƒ¼ãƒ»ãƒ‘ãƒ¼ï¼š</span> <strong>ãƒªãƒãƒ¼ãƒ– (éŸ¿ã)</strong>ã€‚<br>ã‚°ãƒ¼âœŠ = ãƒ‰ãƒ©ã‚¤ (éŸ¿ã‹ãªã„)ã€ ãƒ‘ãƒ¼ğŸ– = ãƒ›ãƒ¼ãƒ«ã®ã‚ˆã†ãªéŸ¿ãã€‚</li>
        </ul>
    </div>

    <div id="container">
        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startButton = document.getElementById('start-button');
        const statusDiv = document.getElementById('status');
        const fileInput = document.getElementById('audio-upload');

        let isPlaying = false;
        let player = null;
        let lowPassFilter, reverb, masterVolume;

        // ==============================================
        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆæœŸè¨­å®š
        // ==============================================
        // Filter: å³æ‰‹ã§æ“ä½œ (åˆæœŸå€¤ã¯å…¨é–‹)
        lowPassFilter = new Tone.Filter(20000, "lowpass");
        
        // Reverb: å·¦æ‰‹ã§æ“ä½œ
        reverb = new Tone.Reverb({ decay: 4, wet: 0 }); // decayé•·ã‚ã§è˜å³ã«

        masterVolume = new Tone.Volume(0);
        
        // æ¥ç¶šé †åº: Player -> Filter -> Reverb -> Volume -> Out
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§éŸ³ã‚’ã“ã‚‚ã‚‰ã›ã¦ã‹ã‚‰ãƒªãƒãƒ¼ãƒ–ã‚’ã‹ã‘ã‚‹ã®ãŒè‡ªç„¶
        lowPassFilter.connect(reverb);
        reverb.connect(masterVolume);
        masterVolume.toDestination();

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (player) {
                player.stop();
                player.dispose();
                player = null;
            }
            if (isPlaying) {
                isPlaying = false;
                startButton.textContent = "Start Conductor";
            }

            startButton.disabled = true;
            statusDiv.textContent = `è§£æä¸­: ${file.name} ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...`;
            startButton.textContent = "Loading...";

            const fileUrl = URL.createObjectURL(file);

            player = new Tone.GrainPlayer({
                url: fileUrl,
                loop: true,
                grainSize: 0.1,
                overlap: 0.05,
                onload: () => {
                    statusDiv.textContent = "è§£æå®Œäº†ã€‚é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                    startButton.textContent = "Start Conductor";
                    startButton.disabled = false;
                }
            });

            player.connect(lowPassFilter);
        });

        // é–‹å§‹ãƒœã‚¿ãƒ³å‡¦ç†
        startButton.addEventListener('click', async () => {
            if (!player) return;

            if (!isPlaying) {
                await Tone.start(); 
                player.start();
                isPlaying = true;
                startButton.textContent = "Stop";
                statusDiv.textContent = "æ¼”å¥ä¸­... å³æ‰‹:ãƒ†ãƒ³ãƒ/æ˜æš—, å·¦æ‰‹:éŸ³é‡/éŸ¿ã";
                camera.start();
            } else {
                player.stop();
                isPlaying = false;
                startButton.textContent = "Start Conductor";
                statusDiv.textContent = "ä¸€æ™‚åœæ­¢ä¸­";
            }
        });

        // MediaPipe Logic
        let rightHandSpeeds = [];
        const speedHistorySize = 15;
        let lastRightHandY = null;
        let lastFrameTime = performance.now();

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandedness && isPlaying) {
                let rightHand = null;
                let leftHand = null;

                // å·¦å³åˆ¤å®š (é¡åƒ)
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const label = results.multiHandedness[i].label;
                    const landmarks = results.multiHandLandmarks[i];
                    if (label === 'Left') rightHand = landmarks; 
                    else leftHand = landmarks;

                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 3});
                }

                const currentTime = performance.now();
                const deltaTime = (currentTime - lastFrameTime) / 1000;

                // ===============================================
                // 1. å³æ‰‹ (Right Hand): Tempo & Tone(Filter)
                // ===============================================
                if (rightHand) {
                    // --- A. ãƒ†ãƒ³ãƒ (ä¸Šä¸‹ã®é€Ÿåº¦) ---
                    if (deltaTime > 0 && lastRightHandY !== null) {
                        const wristY = rightHand[0].y;
                        const speedY = Math.abs(wristY - lastRightHandY) / deltaTime;
                        rightHandSpeeds.push(speedY);
                        if (rightHandSpeeds.length > speedHistorySize) rightHandSpeeds.shift();

                        const avgSpeed = rightHandSpeeds.reduce((a, b) => a + b, 0) / rightHandSpeeds.length;
                        
                        let targetRate = 1.0 + (avgSpeed * 0.6); 
                        targetRate = Math.max(0.5, Math.min(targetRate, 2.5));

                        if(player.playbackRate) {
                             player.playbackRate = player.playbackRate * 0.9 + targetRate * 0.1;
                        }
                    }
                    if (deltaTime > 0) lastRightHandY = rightHand[0].y;

                    // --- B. éŸ³è‰² (ã‚°ãƒ¼ãƒ»ãƒ‘ãƒ¼) -> Filter Frequency ---
                    // ä»Šå›ã®å¤‰æ›´ç‚¹: å³æ‰‹ã®æ¡ã‚Šã§éŸ³ã®æ˜ã‚‹ã•ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
                    const wrist = rightHand[0];
                    const middleFingerTip = rightHand[12];
                    const distance = Math.sqrt(Math.pow(wrist.x - middleFingerTip.x, 2) + Math.pow(wrist.y - middleFingerTip.y, 2));

                    // ãƒãƒƒãƒ”ãƒ³ã‚°: ã‚°ãƒ¼(è·é›¢å°)=200Hz(æš—ã„/ã“ã‚‚ã‚‹), ãƒ‘ãƒ¼(è·é›¢å¤§)=20000Hz(æ˜ã‚‹ã„/å…¨é–‹)
                    let openAmount = (distance - 0.15) * 4; 
                    openAmount = Math.max(0, Math.min(openAmount, 1));

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯æŒ‡æ•°çš„ã«å‹•ã‹ã™ã¨è‡ªç„¶
                    // minFreq: å®Œå…¨ã«ã“ã‚‚ã£ãŸéŸ³, maxFreq: ç”ŸéŸ³
                    const minFreq = 200; 
                    const maxFreq = 20000;
                    // æ›²ç·šã‚’æ„è­˜ã—ãŸãƒãƒƒãƒ”ãƒ³ã‚° (2ä¹—ã‚«ãƒ¼ãƒ–ã§æ€¥æ¿€ãªå¤‰åŒ–ã‚’é¿ã‘ã‚‹)
                    const targetFreq = minFreq + (maxFreq - minFreq) * (openAmount * openAmount);

                    lowPassFilter.frequency.rampTo(targetFreq, 0.1);

                } else {
                    // æ‰‹ãŒãªã„æ™‚ã¯æ¨™æº–é€Ÿåº¦
                    if(player.playbackRate) {
                        player.playbackRate = player.playbackRate * 0.95 + 1.0 * 0.05;
                    }
                }
                lastFrameTime = currentTime;


                // ===============================================
                // 2. å·¦æ‰‹ (Left Hand): Volume & Reverb
                // ===============================================
                if (leftHand) {
                    // --- A. éŸ³é‡ (é«˜ã•) ---
                    const wristY = leftHand[0].y;
                    let targetVolume = (1.0 - wristY) * 35 - 30; 
                    targetVolume = Math.max(-60, Math.min(targetVolume, 10));
                    masterVolume.volume.rampTo(targetVolume, 0.1);

                    // --- B. ãƒªãƒãƒ¼ãƒ– (ã‚°ãƒ¼ãƒ»ãƒ‘ãƒ¼) ---
                    // ä»Šå›ã®å¤‰æ›´ç‚¹: å·¦æ‰‹ã¯ãƒªãƒãƒ¼ãƒ–ã«æˆ»ã™
                    const wrist = leftHand[0];
                    const middleFingerTip = leftHand[12];
                    const distance = Math.sqrt(Math.pow(wrist.x - middleFingerTip.x, 2) + Math.pow(wrist.y - middleFingerTip.y, 2));

                    // ãƒãƒƒãƒ”ãƒ³ã‚°: ã‚°ãƒ¼=Dry(0), ãƒ‘ãƒ¼=Wet(æœ€å¤§0.5ãã‚‰ã„)
                    let openAmount = (distance - 0.15) * 4; 
                    openAmount = Math.max(0, Math.min(openAmount, 1));
                    
                    const maxReverb = 0.5; // ãƒªãƒãƒ¼ãƒ–ã®ã‹ã‹ã‚Šã™ãã‚’é˜²ã
                    const targetWet = openAmount * maxReverb;

                    reverb.wet.rampTo(targetWet, 0.2); // å°‘ã—ã‚†ã£ãã‚Šå¤‰åŒ–ã•ã›ã‚‹
                }
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        
    </script>
</body>
</html>
