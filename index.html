<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Conductor - Slow & Dynamic Reverb</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #222;
            color: white;
            font-family: sans-serif;
            padding-bottom: 50px;
        }
        #container {
            position: relative;
            width: 640px;
            height: 480px;
            margin-top: 10px;
            background-color: #000;
            border: 1px solid #444;
        }
        #input_video { display: none; }
        #output_canvas {
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        .ui-panel {
            margin-top: 20px;
            padding: 20px;
            background: #333;
            border-radius: 8px;
            text-align: center;
            width: 600px;
        }
        .settings-panel {
            margin-top: 20px;
            padding: 20px;
            background: #181818;
            border: 1px solid #444;
            border-radius: 8px;
            width: 600px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        .setting-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }
        .val-display { color: #4CAF50; font-weight: bold; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 4px;
            transition: opacity 0.3s;
        }
        #start-button { background-color: #4CAF50; }
        #camera-reset-button { background-color: #2196F3; }
        
        button:disabled { background-color: #555 !important; cursor: not-allowed; }
        button:active { opacity: 0.8; }
        
        h2 { font-size: 1.1em; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 0; color: #ddd;}
        
        /* å¤‰æ›´ç‚¹ã®å¼·èª¿ */
        .highlight-text { color: #ffeb3b; font-size: 0.9em; margin-bottom: 10px; display: block;}
    </style>
</head>
<body>
    <div class="ui-panel">
        <h1>AI Conductor (Slow & Wide)</h1>
        <span class="highlight-text">â˜… é™æ­¢ã§0.5å€é€Ÿ(ã‚¹ãƒ­ãƒ¼) â‡” æŒ¯ã‚‹ã¨åŠ é€Ÿ</span>
        <div>
            <label>éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ: </label><br>
            <input type="file" id="audio-upload" accept="audio/*" style="margin:10px 0;">
        </div>
        
        <div class="btn-group">
            <button id="start-button" disabled>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</button>
            <button id="camera-reset-button" disabled>ğŸ”„ ã‚«ãƒ¡ãƒ©å†èµ·å‹•</button>
        </div>
        <div id="status" style="margin-top:10px; color:#0f0; min-height:1.2em;">å¾…æ©Ÿä¸­...</div>
    </div>

    <div id="container">
        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <div class="settings-panel">
        <div style="grid-column: span 2;">
            <h2>æ„Ÿåº¦èª¿æ•´</h2>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <label>ã€å³æ‰‹ã€‘ãƒ†ãƒ³ãƒæ„Ÿåº¦ (æŒ¯ã‚‹å¼·ã•)</label>
                <span class="val-display" id="val-tempo">1.0</span>
            </div>
            <input type="range" id="param-tempo" min="0.1" max="5.0" step="0.1" value="1.0">
            <small style="color:#666; font-size:0.7em;">â€»æ­¢ã‚ã‚‹ã¨0.5å€é€Ÿã«ãªã‚Šã¾ã™</small>
        </div>
        <div class="setting-item">
            <div class="setting-header">
                <label>ã€å³æ‰‹ã€‘æ˜æš—(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)æ„Ÿåº¦</label>
                <span class="val-display" id="val-filter">4.0</span>
            </div>
            <input type="range" id="param-filter" min="1.0" max="10.0" step="0.5" value="4.0">
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <label>ã€å·¦æ‰‹ã€‘éŸ³é‡ãƒ¬ãƒ³ã‚¸ (dB)</label>
                <span class="val-display" id="val-vol-range">50</span>
            </div>
            <input type="range" id="param-vol-range" min="10" max="80" step="5" value="50">
        </div>
        <div class="setting-item">
            <div class="setting-header">
                <label>ã€å·¦æ‰‹ã€‘æœ€ä½éŸ³é‡ (Offset)</label>
                <span class="val-display" id="val-vol-offset">-40</span>
            </div>
            <input type="range" id="param-vol-offset" min="-80" max="-10" step="5" value="-40">
        </div>
        <div class="setting-item">
            <div class="setting-header">
                <label>ã€å·¦æ‰‹ã€‘ãƒªãƒãƒ¼ãƒ–æ„Ÿåº¦ (å¤§èƒ†ã«!)</label>
                <span class="val-display" id="val-reverb">5.0</span>
            </div>
            <input type="range" id="param-reverb" min="1.0" max="10.0" step="0.5" value="5.0">
        </div>
        <div class="setting-item">
            <div class="setting-header">
                <label>æ»‘ã‚‰ã‹ã• (ãƒ•ãƒ¬ãƒ¼ãƒ æ•°)</label>
                <span class="val-display" id="val-smooth">15</span>
            </div>
            <input type="range" id="param-smooth" min="1" max="60" step="1" value="15">
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startButton = document.getElementById('start-button');
        const resetCameraButton = document.getElementById('camera-reset-button');
        const statusDiv = document.getElementById('status');
        const fileInput = document.getElementById('audio-upload');

        const inputs = {
            tempo: document.getElementById('param-tempo'),
            filter: document.getElementById('param-filter'),
            volRange: document.getElementById('param-vol-range'),
            volOffset: document.getElementById('param-vol-offset'),
            reverb: document.getElementById('param-reverb'),
            smooth: document.getElementById('param-smooth')
        };
        const displays = {
            tempo: document.getElementById('val-tempo'),
            filter: document.getElementById('val-filter'),
            volRange: document.getElementById('val-vol-range'),
            volOffset: document.getElementById('val-vol-offset'),
            reverb: document.getElementById('val-reverb'),
            smooth: document.getElementById('val-smooth')
        };

        Object.keys(inputs).forEach(key => {
            inputs[key].addEventListener('input', (e) => {
                displays[key].textContent = e.target.value;
            });
        });

        let isPlaying = false;
        let player = null;
        let lowPassFilter, reverb, masterVolume;

        // Tone.js Setup
        lowPassFilter = new Tone.Filter(20000, "lowpass");
        reverb = new Tone.Reverb({ decay: 5, wet: 0 }); // decayã‚’å°‘ã—é•·ã‚ã«(5s)
        masterVolume = new Tone.Volume(0);
        lowPassFilter.connect(reverb);
        reverb.connect(masterVolume);
        masterVolume.toDestination();

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (player) {
                player.stop();
                player.dispose();
                player = null;
            }
            if (isPlaying) {
                isPlaying = false;
                startButton.textContent = "Start Conductor";
            }

            startButton.disabled = true;
            statusDiv.textContent = `è§£æä¸­...`;
            startButton.textContent = "Loading...";

            const fileUrl = URL.createObjectURL(file);

            player = new Tone.GrainPlayer({
                url: fileUrl,
                loop: true,
                grainSize: 0.1,
                overlap: 0.05,
                onload: () => {
                    statusDiv.textContent = "æº–å‚™å®Œäº†";
                    startButton.textContent = "Start Conductor";
                    startButton.disabled = false;
                }
            });
            player.connect(lowPassFilter);
        });

        startButton.addEventListener('click', async () => {
            if (!player) return;
            if (!isPlaying) {
                await Tone.start(); 
                player.start();
                isPlaying = true;
                startButton.textContent = "Stop";
                statusDiv.textContent = "æ¼”å¥ä¸­";
                
                await camera.start();
                resetCameraButton.disabled = false;
            } else {
                player.stop();
                isPlaying = false;
                startButton.textContent = "Start Conductor";
                statusDiv.textContent = "ä¸€æ™‚åœæ­¢ä¸­";
            }
        });

        resetCameraButton.addEventListener('click', async () => {
            statusDiv.textContent = "ã‚«ãƒ¡ãƒ©å†æ¥ç¶šä¸­...";
            try {
                await camera.start();
                statusDiv.textContent = "ã‚«ãƒ¡ãƒ©å¾©å¸°å®Œäº† (æ¼”å¥ç¶™ç¶šä¸­)";
            } catch (e) {
                console.error(e);
                statusDiv.textContent = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„";
            }
        });

        // MediaPipe Logic
        let rightHandSpeeds = [];
        let lastRightHandY = null;
        let lastFrameTime = performance.now();

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            const settingTempo = Number(inputs.tempo.value);
            const settingFilter = Number(inputs.filter.value);
            const settingVolRange = Number(inputs.volRange.value);
            const settingVolOffset = Number(inputs.volOffset.value);
            const settingReverb = Number(inputs.reverb.value);
            const settingSmooth = Number(inputs.smooth.value);

            if (results.multiHandLandmarks && results.multiHandedness && isPlaying) {
                let rightHand = null;
                let leftHand = null;

                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const label = results.multiHandedness[i].label;
                    const landmarks = results.multiHandLandmarks[i];
                    if (label === 'Left') rightHand = landmarks; 
                    else leftHand = landmarks;

                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 3});
                }

                const currentTime = performance.now();
                const deltaTime = (currentTime - lastFrameTime) / 1000;

                // --- å³æ‰‹å‡¦ç† ---
                if (rightHand) {
                    // ãƒ†ãƒ³ãƒ: é™æ­¢ã§0.5å€ã€æŒ¯ã‚‹ã¨åŠ é€Ÿ
                    if (deltaTime > 0 && lastRightHandY !== null) {
                        const wristY = rightHand[0].y;
                        const speedY = Math.abs(wristY - lastRightHandY) / deltaTime;
                        rightHandSpeeds.push(speedY);
                        while (rightHandSpeeds.length > settingSmooth) rightHandSpeeds.shift();
                        const avgSpeed = rightHandSpeeds.reduce((a, b) => a + b, 0) / rightHandSpeeds.length;
                        
                        // è¨ˆç®—å¼å¤‰æ›´: ãƒ™ãƒ¼ã‚¹ã‚’0.5ã«ã™ã‚‹
                        // 0.5(ã‚¹ãƒ­ãƒ¼) + (å‹•ã * æ„Ÿåº¦)
                        let targetRate = 0.5 + (avgSpeed * settingTempo);
                        
                        // æœ€å°å€¤ã¯0.1ãã‚‰ã„ã§ã‚¯ãƒªãƒƒãƒ—(æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«)
                        if (targetRate < 0.1) targetRate = 0.1; 
                        if (targetRate > 5.0) targetRate = 5.0;

                        if(player.playbackRate) {
                             player.playbackRate = player.playbackRate * 0.9 + targetRate * 0.1;
                        }
                    }
                    if (deltaTime > 0) lastRightHandY = rightHand[0].y;

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    const wrist = rightHand[0];
                    const middle = rightHand[12];
                    const distance = Math.sqrt(Math.pow(wrist.x - middle.x, 2) + Math.pow(wrist.y - middle.y, 2));

                    let openAmount = (distance - 0.15) * settingFilter;
                    if (openAmount < 0) openAmount = 0;
                    
                    let targetFreq = 200 + (19800) * (openAmount * openAmount);
                    if (targetFreq > 22000) targetFreq = 22000;

                    lowPassFilter.frequency.rampTo(targetFreq, 0.1);
                } else {
                    // æ‰‹ãŒãªã„æ™‚ã¯ã‚¹ãƒ­ãƒ¼(0.5)ã«æˆ»ã‚‹ã‚ˆã†ã«å¤‰æ›´
                    if(player.playbackRate) player.playbackRate = player.playbackRate * 0.95 + 0.5 * 0.05;
                }
                lastFrameTime = currentTime;

                // --- å·¦æ‰‹å‡¦ç† ---
                if (leftHand) {
                    // éŸ³é‡
                    const wristY = leftHand[0].y; 
                    let targetVolume = (1.0 - wristY) * settingVolRange + settingVolOffset;
                    if (targetVolume > 10) targetVolume = 10; 
                    masterVolume.volume.rampTo(targetVolume, 0.1);

                    // ãƒªãƒãƒ¼ãƒ– (æ„Ÿåº¦ã‚¢ãƒƒãƒ—ç‰ˆ)
                    const wrist = leftHand[0];
                    const middle = leftHand[12];
                    const distance = Math.sqrt(Math.pow(wrist.x - middle.x, 2) + Math.pow(wrist.y - middle.y, 2));

                    let openAmount = (distance - 0.15) * settingReverb;
                    if (openAmount < 0) openAmount = 0;
                    
                    // ãƒªãƒãƒ¼ãƒ–ã¯1.0 (100% Wet) ã§ååˆ†å¼·çƒˆã ãŒã€
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„Ÿåº¦è¨­å®šãŒé«˜ã‘ã‚Œã°å³åº§ã«1.0ã«å¼µã‚Šä»˜ãã‚ˆã†ã«ãªã‚‹
                    let targetWet = openAmount * 0.5; // Tone.jsã®ä»•æ§˜ä¸Š 1.0ã‚’è¶…ãˆãªã„ã‚ˆã†ãƒ™ãƒ¼ã‚¹ä¿‚æ•°ã‚’èª¿æ•´
                    if (targetWet > 1.0) targetWet = 1.0; 

                    reverb.wet.rampTo(targetWet, 0.2);
                }
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
    </script>
</body>
</html>
